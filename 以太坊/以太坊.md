# 以太坊

以太坊将比特币针对数字货币交易的功能进一步进行了扩展，面向更为复杂和灵活的应用场景，支持了智能合约这一重要特性。

从此，区块链技术的应用场景，从单一基于UTXO的数字货币交易，延伸到图灵完备的通用计算领域。

基于以太坊项目，以太坊团队目前运营了一个公开的区块链平台-以太坊网络。智能合约开发者使用官方提供的工具和以太坊专用应用开发语言Solidity，可以很容易地开发出运行在以太坊网络上的去中心化应用。这些应用将运行在以太坊的虚拟机里，用户通过以太币来购买燃料，维持所部署应用的运行。

与比特币项目相比，以太坊区块链的技术特点主要包括：

- 支持图灵完备的智能合约，设计了编程语言Solidity和虚拟机EVM
- 选用了内存需求较高的哈希函数，避免出现强算力矿机，矿池攻击
- 叔块激励机制，降低矿池的优势，并减少了区块产生间隔时间（从10分钟降到15秒）
- 采用账户系统和世界状态，而不是UTXO，容易支持更复杂的逻辑
- 通过Gas限制代码执行指令数，避免循环执行攻击
- 支持POW共识算法，并计划支持效率更高的POS算法。

### 智能合约

以太坊支持通过图灵完备的高级语言（Solidity, Serpent, Viper)等开发智能合约。智能合约作为运行在以太坊虚拟机中的应用，可以接受来自外部的交易请求和事件，通过触发运行提前编写好的代码逻辑，进一步生成新的交易和事件，可以进一步调用其他智能合约。

智能合约的执行结果可能对以太坊网络上的账本状态进行更新。这些修改由于经过了以太坊网络中的共识，一旦确认后无法被伪造和篡改。

### 账户

以太坊不同于比特币使用UTXO来计算账户余额，以太坊直接使用账户记录系统状态，每个账户存储余额信息、智能合约代码和内部数据存储等。以太坊支持在不同的账户之间转移数据，以实现更为复杂的逻辑。

以太坊账户分为两种类型：

##### 合约账户

存储执行的智能合约代码，只能被外部账户来调用激活

##### 外部账户

以太币拥有者账户，对应到某私钥。账户包括nonce、balance、storageRoot、codeHash等字段，有个人来控制。

当合约账户被调用时，存储其中的智能合约会在矿工处的虚拟机中自动执行，并消耗一定的燃料。燃料通过外部账户中的以太币进行购买。

### 交易

交易在以太坊中是指从一个账户到另一个账户的消息数据。消息可以是以太币或者合约执行参数。

以太坊采用交易作为执行操作的最小单位。每个交易包括如下字段：

- to: 目标账号地址
- value: 指定转移的比特币数量
- nonce: 交易相关的字串
- gasPrice: 执行交易需要消耗的Gas价格
- startgas: 交易消耗的最大Gas值
- signature: 签名信息

类似于比特币网络，在发送交易时，用户需要缴纳一定的交易费用，通过以太币方式进行支付和消耗。

### 以太币

以太币是以太坊网络中的货币

以太币主要用于购买燃料，支付给矿工，以维护以太坊网络运行智能合约的费用。

以太币同样可以通过挖矿来生成，成功生成新区块的以太坊矿工可以获得5个以太币的奖励，以及包含在区块内交易的燃料费用。用户也可以通过交易市场来直接购买以太币。

### 燃料

燃料，控制每次交易执行指令的上限。每执行一条合约指令会消耗固定的燃料。当某个交易还未执行结束，而燃料消耗完时，合约执行终止并回滚状态。

Gas可以根以太币进行兑换，需要注意的是，以太币的价格是波动的，但运行某段智能合约的燃料费用可以是固定的，通过设定Gas价格等进行调节。

### 智能合约

##### 运行环境

以太坊采用以太坊虚拟机作为智能合约的运行环境，以太坊虚拟机是一个隔离的轻量级虚拟机环境，运行在其中的智能合约代码无法访问本地网络、文件系统或其他进程

对同一个智能合约来说，往往需要在多个以太坊虚拟机中同时运行多份，以确保整个区块链数据的一致性和高度的容错性，但另一方面，这也限制了整个网络的容量。

##### 开发语言

以太坊为编写智能合约设计了图灵完备的高级编程语言，降低了智能合约开发的难度。目前，Solidity是最常见的以太坊合约编写语言之一。

智能合约编写完毕后，用编译器编译为以太坊虚拟机专用的二进制格式，由客户端上传到区块链当中，之后在矿工的以太坊虚拟机中执行。

##### 交易模型

UTXO和账户模型对比表

| 特性           | UTXO模型     | 账户模型                 |
| -------------- | ------------ | ------------------------ |
| 状态查询与变更 | 需要回溯历史 | 直接访问                 |
| 存储空间       | 较大         | 较小                     |
| 易用性         | 较难处理     | 易于理解和编程           |
| 安全性         | 较好         | 需要处理好重放攻击等情况 |
| 可追溯性       | 支持历史     | 不支持追溯历史           |

##### 共识

以太坊目前采用了基于成熟的POW共识的变种算法Ethash协议作为共识机制。

为了防止ASIC矿机的算力攻击，跟原始Pow的计算密集型Hash运算不同，Ethash在执行时候需要消耗大量内存，反而和计算效率关系不大。通用机器可能更加有效。

##### 降低攻击

由于以太坊网络中的交易更加多样化，也就更容易收到攻击。

以太坊网络在降低攻击方面的核心设计思想仍然是通过经济激励机制防止少数人作恶；

- 所有交易都要提供交易费用，避免DDos攻击
- 程序运行指令数通过Gas来限制，所消耗的费用超过设定上限时就会被取消，避免出现恶意合约。

##### 提供扩展性

可扩展性是以太坊网络承接更多业务量的最大制约。以太坊项目未来希望通过分片机制提高整个网络的扩展性。

##### 智能合约与传统合约对比

| 比较难度     | 智能合约         | 传统合约         |
| ------------ | ---------------- | ---------------- |
| 自动化维度   | 自动判断触发条件 | 人工判断触发条件 |
| 主客观维度   | 适合客观性的请求 | 适合主观性的请求 |
| 成本维度     | 低成本           | 高成本           |
| 执行时间维度 | 事前预防         | 事后执行         |
| 违约惩罚维度 | 依赖于抵押资产   | 依赖于刑罚       |
| 适用范围维度 | 全球性           | 受限于具体辖区   |

### 智能合约与区块链的关系

如果说区块链1.0是以比特币为代表，解决了货币和支付手段的去中心化问题。那么区块链2.0就是更宏观地对整个市场去中心化，利用区块链技术转换许多不同的数字资产而不仅仅是比特币，通过转换创建不同资产的价值。区块链技术的去中心化账本功能可以被用来创建、确认、转移各种不同类型的资产及合约。几乎所有类型的金融交易都可以被改造成在区块链上使用，包括股票、私募股权、众筹、债券和其他类型的金融衍生品如期货、期权等。

智能合约看上去就是一段计算机执行程序，满足可准确自动执行即可，那么为什么用传统的技术很难实现，而需要区块链技术等新技术呢？传统技术即使通过软件限制、性能优化等方法，也无法同时实现区块链的特性：一是数据无法删除、修改、只能新增，保证了历史的可追溯，同时作恶的成本将很高，因为起作恶行为将永远记录；二是去中心化，避免了中心化因素的影响。

智能合约的存在只是为了让一组复杂的、带有触发条件的数字化承诺能够按照参与者的意志，正确执行。