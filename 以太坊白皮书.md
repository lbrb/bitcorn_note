# 以太坊白皮书

### 以太坊账户

在以太坊系统中，状态是由被称为“账户”（每个账户由20字节的地址）的对象和在两个账户之间转移价值和信息的状态转换构成的。以太坊的账户包含四个部分：

- 随机数，用于确定每笔交易只能被处理一次的计数器
- 账户目前的比特币余额
- 账户的合约代码，如果有的话
- 账户的存储（默认为空）

人们可以通过创建和签名一笔交易从一个外部账户发送消息。每当合约账户收到一条消息，合约内部的代码被激活，允许它对内部存储进行读取和写入、以及发送其他消息或者创建合约。

### 消息和交易

以太坊的消息在某种程度上类似于比特币的交易，但两者之间存在三点重要的不同。

1. 以太坊的消息可以由外部实体或者合约创建，而比特币的交易只能从外部创建。
2. 以太坊的消息可以选择包含数据
3. 如果以太坊的消息的接受者是合约账户，可以选择进行回应，这意味着以太坊消息也包含函数概念

以太坊中的交易是指存储从外部账户发出的消息的签名数据包。交易包含消息的接受者、用于确认发送者的签名、以太币账户余额、要发送的数据和两个被称为STARTGAS和GASPRICE的数值。

### 以太坊状态转换函数

以太坊的状态转换函数：APPLY（S, TX)->S`, 可以定义如下：

1. 检查交易的格式是否正确（即有正确数值）、签名是否有效和随机数是否与发送者账户的随机数匹配。如否，返回错误。
2. 计算交易费用：fee=STARTGAS*GASPRICE, 并从签名中确认发送者的地址。从发送者的账户中减去交易费用和增加发送者的随机数。如果账户余额不足，返回错误。
3. 设定初值GAS=STARTGAS，并根据交易中的字节数减去一定量的瓦斯值
4. 从发送者的账户转移价值到接受者账户。如果接受者账户还不存在，创建此账户。如果接收账户是一个合约，运行合约的代码，直到代码运行结束或者瓦斯用完。
5. 如果因为发送者账户没有足够的钱或者代码执行耗尽瓦斯导致价值转移失败，恢复原来的状态，但是还是要支付交易费用，交易费用加至矿工账户中。
6. 否则，将所有剩余的瓦斯归还给发送者，消耗掉的瓦斯作为交易费用发送给矿工。

### 代码执行

以太坊合约的代码使用低级的基于堆栈的字节码的语言写成的，代码由一系列字节构成，每个字节代表一种操作。操作可以访问三种存储数据的空间：

- 堆栈，一种先进后出的数据存储，32字节的数值可以入栈、出栈
- 内存，可无限扩展的字节队列
- 合约的长期存储，一个秘钥、数值的存储，其中秘钥和数值都是32字节大小，与计算结束即重置的堆栈和内存不同，存储内容将长期保持。

代码可以像访问区块头数据一样访问数值，发送者和接受到的消息中的数据，代码还可以返回数据的字节队列作为输出。

### 区块链和挖矿

虽然有一些不同，但以太坊的区块链在很多方面类似于比特币区块链。他们的区块链架构的不同在于，以太坊区块不仅包含交易记录和最近的状态，还包含区块序号和难度值。以太坊中的区块确认算法如下：

1. 检查区块引用的上一个区块是否存在和有效。

2. 检查区块的时间戳是否比引用的上一个区块大，而且小于15分钟

3. 检查区块序号、难度值、交易根、叔根和瓦斯限额是否有效

4. 检查区块的工作量证明是否有效

5. 将S[0]赋值为上一个区块的STATE_ROOT

6. 将TX赋值为区块的交易列表，一共有n笔交易。对于属于0..n-1的i,进行状态转换S[i+1]=APPLY(S[i], TX[i])。如果任何一个转换发生错误，或者程序执行到此处所花费的瓦斯超过了GASLIMIT,返回错误

7. 用S[n]给S_FINAL赋值，向矿工支付区块奖励

8. 检查S_FINAL是否与START_ROOT相同，如果相同，区块是有效的，否则，区块是无效的

   这一确认方法咋看起来似乎效率很低，因为它需要存储每个区块的所有状态，但是事实上以太坊的确认效率可以与比特币相提并论。原因是状态存储在树结构中，每增加一个区块只需要改变树结构的一小部分。因此，一般而言，两个相邻的区块的树结构的大部分应该是相同的，因此，存储一次数据，可以利用指针（即子树哈希）引用两次，一种被称为“帕特里夏树”的树结构可以实现这一点，其中包括了对默克尔树概念的修改，不仅允许改变节点，而且还可以插入和删除节点。另外，因为所有的状态信息是最后一个区块的一部分，所以没有必要存储全部的区块历史，这一方法如果能够可以应用到比特币系统中，经计算可以对存储空间有10-20倍的节省。

   

   